报表监控集成要求
1、拷贝reportEngine的src/test/resources/report_conf目录所有文件到自己的工程

2、将reportEngine的src/main/webapp/js/monitor.js到自己工程的相应目录，此js在custom_macro.ftl的head中引用

3、将custom_macro.ftl中的<#assign system = "reportEngine">更改为自己的系统代号

4、报表开发配置约定

	4.1、用户登录后，将用户的passport写入session，代码如下
		HttpSession session = getRequest().getSession();
		session.setAttribute("monitor_report_passport", passport);
	4.2、table的column配置，如果不是监控的指标列(时间或者维度列)，需要加上isKpi="false"，这些列将作为报表数据的  主键列  ，参考如下：
		<column label="日期" isKpi="false">
		<column label="新增机器">
	4.3、时间参数只能是startDate和endDate(可以只有一个)，业务确实需要其他时间参数的报表，暂不支持监控
	4.4、如果是留存类报表，或者报表数据监控跟用户查询的startDate和endDate时间差关系密切，在配置table时添加isRetainedData="true"，参考下面配置：（其他类型报表可以不用配置）
		<table id="midNewUserGroupTable" refDataList="midNewUserGroup" title="" pageable="true" isRetainedData="true">
	4.5、报表table的两个column的label描述不得相同，因为此label为监控系统获取数据的key
	4.6、报表数据周期如果不是天的数据，需要在参数中使用tdateType参数名标明周期类型，tdateType支持minute、hour、day、week、month、year六种类型值。参数配置参考如下：
		<param id="tdateType" label="时间周期类型" defaultValue="week" dataType="string"></param>
	4.7、报表参数除了passport，其他参数不要在session中获取，session中获取passport方式
		<param id="passport" hidden="true" defaultValue="${session.getAttribute('passport')}"></param>

5、报表变更通知
	5.1、线上table的column中label描述不得变更，如果因业务需要必须更改的，需通知相关业务人员，之前对此报表的监控将无法获取到正确的数据，需要删除监控，并重新按自己的需求设置监控。
	5.2、线上报表table不建议增加时间或维度column，如因业务需要必须增加的，需通知相关业务人员删除之前此报表的监控，并重新设置监控。增加数据指标column无影响。
	5.3、不得变更已经上线的报表ID以及报表路径，否则已经设置此报表的所有监控将无法获取到数据。
	5.4、报表下线请通知相关业务人员，删除相关数据监控，避免收到无数据报警。



详细介绍：

如果想要了解报表监控更改的模板配置详情，可继续往下阅读：

1、报表模板中定义业务系统代号或名称
<#assign system = "reportEngine">

2、html head中引入monitor.js脚本，脚本在reportEngine的js目录
<script src="${ctx}/js/monitor.js"></script>

3、报表表格模板使用reportEngine工程test/resources/report_conf/macro.ftl模板定义的renderTable，具体如下，添加的a标签为用户可点击的我要监控 
	<#macro renderTable table> 
		<a href="/ReportEngine/monitorArg?reportPath=${reportPath}&metadataId=${table.id}&metadataType=table&isRetainedData=${table.isRetainedData!}" target="_blank" style="background-color: #DDDDDD;background-image: linear-gradient(#DDDDDD, #DDDDDD 5%, #DDDDDD);margin-bottom: 4px;" class="btn btn-round" title="点击设置报表数据监控">我要监控</a>
		<table id="${table.id}" class="table table-striped table-bordered table-hover table-condensed  scrolltable sortable">
			<thead>
				<tr>
				<#list table.columns as col>
					<th>${col.label}</th>
				</#list>
				</tr>
			</thead>
			
			<tbody>
				<#list table.dataList as row>
					<tr>
				<#list table.columns as col>
						<td class="center"><#assign rowValue = col.value?interpret><@rowValue /></td>
				</#list>
					</tr>
				</#list>
			</tbody>
		</table>
		
		<#if table.pageable>
			<@renderPagination table.paginator/>
		</#if>
	</#macro>

4、在所有报表引用的模板中需要以下两个模板，在reportEngine工程test/resources/report_conf/macro.ftl模板中有定义，其中renderMonitorTable为用户点击我要监控后跳转的页面模板，renderMonitorTableXml为报表监控系统后台获取数据xml的模板
	<#macro renderMonitorTable table> 
		<div class="input-prepend">
			<span class="add-on">数据值列:</span>
			<select name="valueTitle" id="valueTitle" onchange="changeCheckedKpi();">
				<#list table.columns as col>
					<#if !col.isKpi?? || col.isKpi> 
			          <option value ="${col.label}">${col.label}</option>
			        </#if>
				</#list>
			</select>
			<a id="tip0" data-placement="bottom" class="btn btn-mini btn-round" style="border-radius: 40px;" data-content=" <font color=#D2691E><strong>数据值列:</strong></font>所监控报表的指标列<br> <font color=#D2691E><strong>维度值:</strong></font>报表中除指标列之外的其他列，与进入此页面之前报表显示的数据相同<br> <font color=#D2691E><strong>维度值中的日期:</strong></font>与查询时间及当前时间有关，监控时数据日期会随着监控时间顺移，并非固定不变<br> " data-original-title="说明" rel="popover" href="javascript:void(0);">
				<i class="icon-question-sign"></i>
			</a>
			<script type="text/javascript">
			  $('#tip0').popover();
			</script>
			<span style="float: right !important;margin-right:30px;">
		    <input class="btn btn-primary" style="border-radius: 3px 3px 3px 3px;" type="button" value="提交" onclick="submitForm('${table.id}')"/>&nbsp;&nbsp;
		    <input class="btn btn-primary" style="border-radius: 3px 3px 3px 3px;" type="button" name="back" value="关闭" onclick="javascript:window.opener=null;window.open('','_self');window.close();"/>
		    &nbsp;&nbsp;
		    </span>
	    </div>
		<#list table.columns as col>
			<#if col.isKpi?? && !col.isKpi>
		          <input type="hidden" name="keyTitles" value="${col.label}"/>
			</#if>
	    </#list>
	    <#if startDate??>
	    	<input type="hidden" id="startDate" name="startDate" value="${startDate}"/>
		</#if>
		 <#if endDate??>
		    <input type="hidden" id="endDate" name="endDate" value="${endDate}"/>
		</#if>
	    <input type="hidden" id="reportPath" name="reportPath" value="${reportUrl}"/>
	    <input type="hidden" id="metadataId"  name="metadataId" value="${table.id}"/>
	    <input type="hidden" id="system"  name="system" value="${system}"/>
	    <input type="hidden" id="queryParams" name="queryParams" value="${queryParams}"/>
	    <input type="hidden" id="monitorReportPassport"  name="monitorReportPassport" value="${monitor_report_passport}"/>
	    <div class="input-prepend">
	    	<span class="add-on">&nbsp;&nbsp;&nbsp;维度值:</span><span style="background:transparent;height:10px;font-size:80%;font-weight:500;color:rgb(128,128,128);">（注:请点击上面<i class="icon-question-sign"></i>图标查看说明）</span>
	    </div>
	    </br>
		<table id="${table.id}" class="table table-striped table-bordered table-hover table-condensed  scrolltable ">
			<thead>
				<tr>
				<th>勾选监控  <a id="checkAllBoxTag" href="javascript:void(0);" onclick="checkAllBox('${table.id}')">全选</a>/<a id="uncheckAllBoxTag" href="javascript:void(0);" onclick="uncheckAllBox('${table.id}')">反选</a></th>
				<#list table.columns as col>
					<#if col.isKpi?? && !col.isKpi>
				          <th>${col.label}</th>
					</#if>
	            </#list>
	            <th>选中的指标</th>
				</tr>
			</thead>
			
			<tbody>
				<#list table.dataList as row>
					<tr>
					<td class="center" style="width: 130px;"><input type="checkbox" name="key" ></td>
					<#list table.columns as col>
						<#if col.isKpi?? && !col.isKpi>
					          <td class="center"><#assign rowValue = col.value?interpret><@rowValue /></td>
						</#if>
	            	</#list>
	            	<td class="center" name="checkedKpi"></td>
					</tr>
				</#list>
			</tbody>
		</table>
	</#macro>
	
	<#macro renderMonitorTableXml table>
	<table id="${table.id}" >
		<#list table.dataList as row>
			<row>
				<#list table.columns as col>
				<rowData isKpi="<#if col.isKpi?? && !col.isKpi>false<#else>true</#if>" >
					<label><![CDATA[${col.label}]]></label>
					<value><#assign rowValue = col.value?interpret> <![CDATA[<@rowValue />]]></value>
				</rowData>
				</#list>
			</row>
		</#list>
	</table>
	</#macro>

5、在report_baseReportDir目录下需要table.ftl和table.xml.ftl两个模板,具体可查看reportEngine工程test/resources/report_conf目录
	5.1、table.ftl内容如下
	<#include "/macro.ftl"/>
	
	<!DOCTYPE html>
	<html lang="en">
	<@renderHtmlHead/>
	
	<body>
		<@block name="body">
		<div class="row-fluid sortable">
			<!-- 切换皮肤需求引用 -->
			<input type="hidden" id="ctx" value="">	
	
			<div class="box rp-table">
				<div class="box-header well">
			</div>
				<div class="box-content">
					<@block name="table"><@renderMonitorTable report.getElementById("${metadataId}")/></@block>
				</div>
			</div>
			<!--/row-->
			
			<!--/row-->
		</div>
		<script type="text/javascript">
			$(function () {
				var checkAllBoxTag = document.getElementById("checkAllBoxTag");
				checkAllBoxTag.click();
				changeCheckedKpi();
			});
			function changeCheckedKpi(){
				var obj = document.getElementById("valueTitle");
				var value = obj.options[obj.selectedIndex].value;
				var kpiArr = document.getElementsByName("checkedKpi");
				for(var i=0;i<kpiArr.length;i++){
					kpiArr[i].innerHTML=value;
				}
			}
		</script>
		</@block> 
	</body>
	</html>

5.2、table.xml.ftl内容
	<#include "/macro.ftl"/>
	<@renderMonitorTableXml report.getElementById("${metadataId}")/>

6、报表开发配置约定
	6.1、用户登录后，将用户的passport写入session，代码如下
		HttpSession session = getRequest().getSession();
		session.setAttribute("monitor_report_passport", passport);
	6.2、table的column配置，如果不是监控的指标列(时间或者维度列)，需要加上isKpi="false"，这些列将作为报表数据的主键列，参考如下：
		<column label="日期" isKpi="false">
		<column label="新增机器">
	6.3、时间参数只能是startDate和endDate(可以只有一个)，业务确实需要其他时间参数的报表，暂不支持监控
	6.4、如果是留存类报表，或者报表数据监控跟用户查询的startDate和endDate时间差关系密切，在配置table时添加isRetainedData="true"，参考下面配置：（其他类型报表可以不用配置）
		<table id="midNewUserGroupTable" refDataList="midNewUserGroup" title="" pageable="true" isRetainedData="true">
	6.5、报表table的两个column的label描述不得相同，因为此label为监控系统获取数据的key
	6.6、报表数据周期如果不是天的数据，需要在参数中使用tdateType参数名标明周期类型，tdateType支持minute、hour、day、week、month、year六种类型值。参数配置参考如下：
		<param id="tdateType" label="时间周期类型" defaultValue="week" dataType="string"></param>
	6.7、报表参数除了passport，其他参数不要在session中获取，session中获取passport方式
		<param id="passport" hidden="true" defaultValue="${session.getAttribute('passport')}"></param>

7、报表变更通知
	7.1、线上table的column中label描述不得变更，如果因业务需要必须更改的，需通知相关业务人员，之前对此报表的监控将无法获取到正确的数据，需要删除监控，并重新按自己的需求设置监控。
	7.2、线上报表table不建议增加时间或维度column，如因业务需要必须增加的，需通知相关业务人员删除之前此报表的监控，并重新设置监控。增加数据指标column无影响。
	7.3、不得变更已经上线的报表ID以及报表路径，否则已经设置此报表的所有监控将无法获取到数据。
	7.4、报表下线请通知相关业务人员，删除相关数据监控，避免收到无数据报警。





